---

# Scenario 44: CTS
#
- name: Scenario 44 - basic cts functions
  hosts: localhost
  vars:
    prefix: scenario44-
  tasks:
    - set_fact:
        prefix: "{{ (prefix + ( lookup('env', 'TASK_EXECUTOR_JOB_ID') | default(99999999 | random | to_uuid | hash('md5'), true) ) )[0:24] }}"

    - set_fact:
        bucket_name: "{{ (prefix + '-cts-apimon') }}"
        bucket_object: "CloudTraces/"

    - block:
      - name: Delete CTS system tracker
        script: "delete_cts_tracker.py"
        args:
          executable: python3
        ignore_errors: true

      - name: Create OBS bucket
        script: "create_container.py {{ bucket_name }}"
        args:
          executable: python3

      - name: Enable CTS system tracker
        script: "create_cts_tracker.py {{ bucket_name }}"
        args:
          executable: python3

      - name: Update CTS system tracker
        script: "update_cts_tracker.py {{ bucket_name }}"
        args:
          executable: python3

      always:
        - block:
          - name: Delete CTS system tracker
            script: "delete_cts_tracker.py"
            args:
              executable: python3


          - name: Delete objects in OBS bucket
            script: "delete_object.py {{ bucket_name}} {{ bucket_object}}"
            args:
              executable: python3     

          - name: Delete OBS container
            script: "delete_container.py {{ bucket_name}} "
            args:
              executable: python3     

          ignore_errors: true
